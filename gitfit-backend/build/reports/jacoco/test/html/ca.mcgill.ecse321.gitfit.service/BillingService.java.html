<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BillingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gitfit</a> &gt; <a href="index.source.html" class="el_package">ca.mcgill.ecse321.gitfit.service</a> &gt; <span class="el_source">BillingService.java</span></div><h1>BillingService.java</h1><pre class="source lang-java linenums">package ca.mcgill.ecse321.gitfit.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;

import ca.mcgill.ecse321.gitfit.dao.BillingRepository;
import ca.mcgill.ecse321.gitfit.dao.CustomerRepository;
import ca.mcgill.ecse321.gitfit.exception.SportCenterException;
import ca.mcgill.ecse321.gitfit.model.Billing;
import ca.mcgill.ecse321.gitfit.model.Customer;
import jakarta.transaction.Transactional;

@Service
<span class="fc" id="L15">public class BillingService {</span>
    @Autowired
    private ValidatorService validatorService;
    @Autowired
    private BillingRepository billingRepository;
    @Autowired
    private CustomerRepository customerRepository;

    /**
     * Create or update billing information for a customer
     *
     * @author Li Yang Lei (LeiLiYang)
     * @param country
     * @param state
     * @param postalCode
     * @param cardNumber
     * @param address
     * @param username
     * @throws SportCenterException if the customer does not exist or the billing
     *                              information fields are not completed
     * @return persisted billing object
     */
    @Transactional
    public Billing createOrUpdateBilling(String country, String state, String postalCode, String cardNumber,
            String address, String username) {

        // input validation
<span class="pc bpc" id="L42" title="10 of 24 branches missed.">        if (country == null || state == null || postalCode == null || cardNumber == null || address == null</span>
                || username == null || country == &quot;&quot; || state == &quot;&quot; || postalCode == &quot;&quot; || cardNumber == &quot;&quot;
                || address == &quot;&quot; || username == &quot;&quot;) {
<span class="fc" id="L45">            throw new SportCenterException(HttpStatus.BAD_REQUEST, &quot;The billing information fields must be completed.&quot;);</span>
        }
<span class="fc" id="L47">        Customer customer = customerRepository.findCustomerByUsername(username);</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (customer == null) {</span>
<span class="fc" id="L49">            throw new SportCenterException(HttpStatus.NOT_FOUND, &quot;The customer does not exist.&quot;);</span>
        }
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (!postalCode.matches(&quot;^[A-Za-z0-9 ]{5,10}$&quot;)) {</span>
<span class="fc" id="L52">            throw new SportCenterException(HttpStatus.BAD_REQUEST,</span>
                    &quot;Postal code must be between 5 and 10 alphanumeric characters&quot;);
        }
<span class="fc bfc" id="L55" title="All 2 branches covered.">        if (!cardNumber.matches(&quot;^[0-9]{15,16}$&quot;)) {</span>
<span class="fc" id="L56">            throw new SportCenterException(HttpStatus.BAD_REQUEST, &quot;Card number must be 15 or 16 digits&quot;);</span>
        }
<span class="fc" id="L58">        Billing ExistingBilling = billingRepository.findBillingByCustomer(customer);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (ExistingBilling != null) {</span>
<span class="nc" id="L60">            ExistingBilling.setCountry(country);</span>
<span class="nc" id="L61">            ExistingBilling.setState(state);</span>
<span class="nc" id="L62">            ExistingBilling.setPostalCode(postalCode);</span>
<span class="nc" id="L63">            ExistingBilling.setCardNumber(cardNumber);</span>
<span class="nc" id="L64">            ExistingBilling.setAddress(address);</span>
<span class="nc" id="L65">            return billingRepository.save(ExistingBilling);</span>
        } else {
<span class="fc" id="L67">            Billing billing = new Billing(country, state, postalCode, cardNumber, address, customer);</span>
<span class="fc" id="L68">            return billingRepository.save(billing);</span>
        }
    }

    /**
     * Get billing information for a customer
     * 
     * @author Li Yang Lei (LeiLiYang)
     * @param username
     * @throws SportCenterException if the customer does not exist or the customer
     *                              does not have billing set up
     * @return billing object
     */

    @Transactional
    public Billing getBilling(String username) {
<span class="fc" id="L84">        Customer customer = customerRepository.findCustomerByUsername(username);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (customer == null) {</span>
<span class="fc" id="L86">            throw new SportCenterException(HttpStatus.NOT_FOUND, &quot;The customer does not exist.&quot;);</span>
        }

<span class="fc" id="L89">        Billing billing = billingRepository.findBillingByCustomer(customer);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (billing == null) {</span>
<span class="fc" id="L91">            throw new SportCenterException(HttpStatus.NOT_FOUND, &quot;The customer does not have billing set up.&quot;);</span>
        }
<span class="fc" id="L93">        return billing;</span>
    }

    /**
     * Delete billing information for a customer
     *
     * @auther Li Yang Lei (LeiLiYang)
     * @param username
     * @throws SportCenterException if the customer does not exist or the customer
     *                              does not have billing set up
     */

    @Transactional
    public void deleteBilling(String username) {
<span class="fc" id="L107">        Customer customer = customerRepository.findCustomerByUsername(username);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (customer == null) {</span>
<span class="fc" id="L109">            throw new SportCenterException(HttpStatus.NOT_FOUND, &quot;The customer does not exist.&quot;);</span>
        }
<span class="fc" id="L111">        Billing billing = billingRepository.findBillingByCustomer(customer);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (billing == null) {</span>
<span class="fc" id="L113">            throw new SportCenterException(HttpStatus.NOT_FOUND, &quot;The customer does not have billing set up.&quot;);</span>
        }
<span class="fc" id="L115">        billingRepository.deleteById(billing.getId());</span>
<span class="fc" id="L116">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>